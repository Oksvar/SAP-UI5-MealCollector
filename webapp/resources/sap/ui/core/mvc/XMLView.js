/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./View","./ViewType","./XMLViewRenderer","sap/base/config","sap/base/future","sap/base/Log","sap/base/i18n/Localization","sap/base/strings/hash","sap/base/util/LoaderExtensions","sap/base/util/merge","sap/ui/base/ManagedObject","sap/ui/core/Control","sap/ui/core/RenderManager","sap/ui/core/XMLTemplateProcessor","sap/ui/core/cache/CacheManager","sap/ui/model/resource/ResourceModel","sap/ui/util/XMLHelper","sap/ui/Global","sap/ui/VersionInfo","sap/ui/performance/trace/Interaction","sap/ui/thirdparty/jquery"],function(e,t,n,r,i,o,s,a,c,u,l,d,p,f,h,m,g,v,w,y,jQuery){"use strict";var C=p.RenderPrefixes,P="XMLViewCacheError",b={};var M=d.extend("sap.ui.core.mvc.XMLAfterRenderingNotifier",{metadata:{library:"sap.ui.core"},renderer:{apiVersion:2,render:function(e,t){e.text("")}}});var x=e.extend("sap.ui.core.mvc.XMLView",{metadata:{library:"sap.ui.core",specialSettings:{containingView:{type:"sap.ui.core.mvc.XMLView",visibility:"hidden"},xmlNode:{type:"Element",visibility:"hidden"},cache:"Object",processingMode:{type:"sap.ui.core.mvc.XMLProcessingMode",visibility:"hidden"},requireContext:"Object"},designtime:"sap/ui/core/designtime/mvc/XMLView.designtime"},renderer:n});sap.ui.xmlview=function(e,n){return sap.ui.view(e,n,t.XML)};x.create=function(n){var r=u({},n);r.viewContent=r.definition;r.async=true;r.type=t.XML;return e.create(r)};x._sType=t.XML;x.asyncSupport=true;x._bUseCache=r.get({name:"sapUiXxViewCache",type:r.Type.Boolean,defaultValue:true,external:true})&&h._isSupportedEnvironment();function E(e){if(e.parseError.errorCode!==0){var t=e.parseError;throw new Error("The following problem occurred: XML parse Error for "+t.url+" code: "+t.errorCode+" reason: "+t.reason+" src: "+t.srcText+" line: "+t.line+" linepos: "+t.linepos+" filepos: "+t.filepos)}}function N(e,t){if(!t){throw new Error("mSettings must be given")}else if(t.viewName&&t.viewContent){throw new Error("View name and view content are given. There is no point in doing this, so please decide.")}else if((t.viewName||t.viewContent)&&t.xmlNode){throw new Error("View name/content AND an XML node are given. There is no point in doing this, so please decide.")}else if(!(t.viewName||t.viewContent)&&!t.xmlNode){throw new Error("Neither view name/content nor an XML node is given. One of them is required.")}else if(t.cache&&!(t.cache.keys&&t.cache.keys.length)){throw new Error("No cache keys provided. At least one is required.")}}function _(e,t){e.mProperties["viewContent"]=t.viewContent;var n=g.parse(t.viewContent);E(n);return n.documentElement}function V(e,t){if((e._resourceBundleName||e._resourceBundleUrl)&&(!t.models||!t.models[e._resourceBundleAlias])){var n=new m({bundleName:e._resourceBundleName,bundleUrl:e._resourceBundleUrl,bundleLocale:e._resourceBundleLocale,async:t.async});var r=n.getResourceBundle();if(r instanceof Promise){return r.then(function(){e.setModel(n,e._resourceBundleAlias)})}e.setModel(n,e._resourceBundleAlias)}}function L(e){e.oAfterRenderingNotifier=new M;e.oAfterRenderingNotifier.addDelegate({onAfterRendering:function(){e.onAfterRenderingBeforeChildren()}})}function R(e){var t=sap.ui.require("sap/ui/core/Component"),n;if(t){while(e){var r=t.getOwnerComponentFor(e);if(r){e=n=r}else{if(e instanceof t){n=e}e=e.getParent&&e.getParent()}}}return n}function A(e,t){var n=R(e),r=n?JSON.stringify(n.getManifest()):null,i=[];i=i.concat(X(e,n),S(),I(e),t.keys);return T(e,i).then(function(e){return{key:e+"("+a(r||"")+")",componentManifest:r,additionalData:t.additionalData}})}function D(e){return e}function T(e,t){return Promise.all(t).then(function(e){e=e.filter(function(e){return e!==b});if(e.every(D)){return e.join("_")}else{var t=new Error("Provided cache keys may not be empty or undefined.");t.name=P;return Promise.reject(t)}})}function X(e,t){var n=t&&t.getMetadata().getName();return[n||window.location.host+window.location.pathname,e.getId(),s.getLanguageTag().toString()].concat(t&&t.getActiveTerminologies()||[])}function I(e){var t=e.getPreprocessors(),n=e.getPreprocessorInfo(false),r=[];function i(e){r.push(e.preprocessor.then(function(e){if(e.getCacheKey){return e.getCacheKey(n)}else{return b}}))}for(var o in t){t[o].forEach(i)}return r}function S(){return w.load().then(function(e){var t="";if(!e.libraries){t=v.buildinfo.buildtime}else{e.libraries.forEach(function(e){t+=e.buildTimestamp})}return t}).catch(function(e){o.warning("version info could not be retrieved","sap.ui.core.mvc.XMLView");o.debug(e);return""})}function B(e,t){var n=e.key;delete e.key;var r=e.additionalData;e.xml=g.serialize(t);if(r&&r.setAdditionalCacheData&&r.getAdditionalCacheData){e.additionalData=r.getAdditionalCacheData()}return h.set(n,e)}function O(e){return h.get(e.key).then(function(t){if(t&&t.componentManifest==e.componentManifest){t.xml=g.parse(t.xml,"application/xml").documentElement;if(t.additionalData){var n=e.additionalData;if(n&&n.setAdditionalCacheData&&n.getAdditionalCacheData){n.setAdditionalCacheData(t.additionalData)}else{o.error("Deprecated: Don't use an object reference for caching additional Data! Use a CacheDataProvider instead!");u(e.additionalData,t.additionalData)}}return t}})}x.prototype.initViewSettings=function(t){var n=this,r;function i(r){n._xContent=r;if(e._supportInfo){e._supportInfo({context:n._xContent,env:{caller:"view",viewinfo:u({},n),settings:u({},t||{}),type:"xmlview"}})}if(!n.isSubView()){f.parseViewAttributes(r,n)}else{delete t.controller}var i=V(n,t);if(i instanceof Promise){return i.then(function(){L(n)})}L(n)}function s(e,t){if(n.hasPreprocessor("viewxml")){return f.enrichTemplateIdsPromise(e,n,t).then(function(){return n.runPreprocessor("viewxml",e,!t)})}return e}function a(e){var t=y.notifyAsyncStep("VIEW PREPROCESSING");return n.runPreprocessor("xml",e).then(function(e){return s(e,true)}).finally(t)}function l(e){return c.loadResource(e,{async:true}).then(function(e){return e.documentElement})}function d(e,t){return l(e).then(a).then(function(e){if(t){B(t,e)}return e})}function p(e,t){return A(n,t).then(function(t){return O(t).then(function(n){if(!n){return d(e,t)}else{return n.xml}})}).catch(function(t){if(t.name===P){o.error(t.message,t.name,"sap.ui.core.mvc.XMLView");o.error("Processing the View without caching.","sap.ui.core.mvc.XMLView");return d(e)}else{return Promise.reject(t)}})}this._oContainingView=t.containingView||this;this._sProcessingMode=t.processingMode;if(this.oAsyncState){this.oAsyncState.suppressPreserve=true}N(this,t);if(t.viewName){var h=t.viewName.replace(/\./g,"/")+".view.xml";if(t.async){if(t.cache&&x._bUseCache){return p(h,t.cache).then(i)}else{return l(h).then(a).then(i)}}else{r=c.loadResource(h).documentElement}}else if(t.viewContent){if(t.viewContent.nodeType===window.Node.DOCUMENT_NODE){r=t.viewContent.documentElement}else{r=_(this,t)}}else if(t.xmlNode){r=t.xmlNode}if(t.async){return a(r).then(i)}else{r=this.runPreprocessor("xml",r,true);r=s(r,false);if(r&&typeof r.getResult==="function"){if(r.isRejected()){throw r.getResult()}r=r.getResult()}i(r)}};x.prototype.onBeforeRendering=function(){var t=this.getDomRef();if(t&&!p.isPreservedContent(t)){p.preserveContent(t,true)}e.prototype.onBeforeRendering.apply(this,arguments)};x.prototype.exit=function(){if(this.oAfterRenderingNotifier){this.oAfterRenderingNotifier.destroy()}e.prototype.exit.apply(this,arguments)};x.prototype.onControllerConnected=function(e,t){var n=this;function r(e){return l.runWithPreprocessors(e,{settings:n._fnSettingsPreprocessor})}if(!this.oAsyncState){this._aParsedContent=r(f.parseTemplate.bind(null,this._xContent,this,t))}else{var i=y.notifyAsyncStep("VIEW PROCESSING");return f.parseTemplatePromise(this._xContent,this,true,{fnRunWithPreprocessor:r}).then(function(e){n._aParsedContent=e;delete n.oAsyncState.suppressPreserve}).finally(i)}};x.prototype.getControllerName=function(){return this._controllerName};x.prototype.isSubView=function(){return this._oContainingView!=this};x.prototype.onAfterRenderingBeforeChildren=function(){if(this._$oldContent.length!==0){var e=this.getAggregation("content");if(e){for(var t=0;t<e.length;t++){var n=document.getElementById(C.Temporary+e[t].getId())||e[t].getDomRef()||document.getElementById(C.Invisible+e[t].getId());if(n){jQuery(document.getElementById(C.Dummy+e[t].getId())).replaceWith(n)}}}jQuery(document.getElementById(C.Temporary+this.getId())).replaceWith(this._$oldContent)}this._$oldContent=undefined};x.prototype._onChildRerenderedEmpty=function(e,t){jQuery(t).replaceWith('<div id="'+C.Dummy+e.getId()+'" class="sapUiHidden"></div>');return true};x.registerPreprocessor=function(t,n,r,o,s,a){var c=this.getMetadata().getClass()._sType;if(typeof r==="string"){if(r!==c){throw new TypeError("View types other than "+c+" are not supported by XMLView.registerPreprocessor,"+" check View.registerPreprocessor instead")}}else{a=s;s=o;o=r}t=t.toUpperCase();if(x.PreprocessorType[t]){e.registerPreprocessor(x.PreprocessorType[t],n,c,o,s,a)}else{i.errorThrows('Preprocessor could not be registered due to unknown sType "'+t+'"',this.getMetadata().getName())}};x.PreprocessorType={XML:"xml",VIEWXML:"viewxml",CONTROLS:"controls"};x.registerPreprocessor("xml","sap.ui.core.util.XMLPreprocessor",true,true);return x});
//# sourceMappingURL=XMLView.js.map