/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/assert","sap/base/Eventing","sap/base/future","sap/base/Log","sap/base/config","sap/base/i18n/Localization","sap/base/util/each","sap/base/util/LoaderExtensions","sap/ui/Device","sap/ui/VersionInfo","sap/ui/core/Lib","sap/ui/core/Theming","sap/ui/core/theming/ThemeHelper","sap/ui/dom/includeStylesheet"],function(e,t,r,a,i,s,n,u,o,c,l,m,d,h){"use strict";const f=new t;var p=150;var g={};var v=/\.sapUiThemeDesignerCustomCss/i;var T=0;var b="sap-ui-core-customcss";var y=false;var L=null;var k=null;var C={};var E;var S={themeLoaded:true,checkThemeApplied:function(){S.reset();A(true);if(!E){S.fireThemeApplied()}},reset:function(){S.themeLoaded=false;if(E){clearTimeout(E);E=null;T=0;k=null;C={}}},_includeLibraryThemeAndEnsureThemeRoot:function(e){var t=e.name;w(t,m.getTheme());w(t,"base");g[t]=e;if(!e.preloadedCss){S.includeLibraryTheme(t,e.variant,e)}},includeLibraryTheme:function(t,r,n){e(typeof t==="string","sLibName must be a string");e(r===undefined||typeof r==="string","sVariant must be a string or undefined");var u=n;if(typeof u==="object"){u=M(n)}if(t!="sap.ui.legacy"&&t!="sap.ui.classic"){var o=i.get({name:"sapUiXxCssVariables",type:i.Type.String,external:true});if(!r){r=""}var c=/^(true|x)$/i.test(o)?"_skeleton":"";var l=s.getRTL()?"-RTL":"";var d,f=t+(r.length>0?"-["+r+"]":r);if(t&&t.indexOf(":")==-1){d="library"+r+c+l}else{d=t.substring(t.indexOf(":")+1)+r;t=t.substring(0,t.indexOf(":"))}var p="sap-ui-theme-"+f;var g="sap-ui-themeskeleton-"+f;var v=/^(true|x|additional)$/i.test(o);if(!document.querySelector("LINK[id='"+p+"']")||v&&!document.querySelector("LINK[id='"+g+"']")){var T=new URL(S._getThemePath(t,m.getTheme()),document.baseURI).toString();var b=document.createElement("link");b.href=T+d+".css"+(u?u:"");var y=b.href;b.href=T+"css_variables.css"+(u?u:"");var L=b.href;R(p);if(v){a.info("Including "+L+" -  sap.ui.core.theming.ThemeManager.includeLibraryTheme()");h(L,p);p="sap-ui-themeskeleton-"+f;R(p)}a.info("Including "+y+" -  sap.ui.core.theming.ThemeManager.includeLibraryTheme()");h(y,p);var k=sap.ui.require("sap/ui/core/theming/Parameters");if(k){k._addLibraryTheme(f)}S.checkThemeApplied()}}},_getThemePath:function(e,t){w(e,t);return sap.ui.require.toUrl((e+".themes."+t).replace(/\./g,"/")+"/")},_updateThemeUrls:function(e,t){var r=document.querySelectorAll("link[id^=sap-ui-theme-],link[id^=sap-ui-themeskeleton-]");Array.prototype.forEach.call(r,function(r){I(r,e,t)})},_attachThemeApplied:function(e){f.attachEvent("applied",e)},_detachThemeApplied:function(e){f.detachEvent("applied",e)},fireThemeApplied:function(){d.reset();var e=sap.ui.require("sap/ui/core/theming/Parameters");if(e){e._reset(true)}f.fireEvent("applied",{theme:m.getTheme()})}};function x(){var e=m.getTheme();var t=S._getThemePath("sap.ui.core",e)+"custom.css";var r=e.indexOf("sap_")===0||e==="base";var i=true;var s=[];if(y&&L===e){g[b]={}}function u(n){var u="sap-ui-theme-"+n;var o=d.checkAndRemoveStyle({prefix:"sap-ui-theme-",id:n});if(o&&document.getElementById("sap-ui-themeskeleton-"+n)){o=d.checkAndRemoveStyle({prefix:"sap-ui-themeskeleton-",id:n})}i=i&&o;if(i){if(!y||L!=e){if(!r&&U(n)){var c=t;var l=M(g["sap.ui.core"]);if(l){c+=l}h(c,b);y=true;a.debug("ThemeManager: delivered custom CSS needs to be loaded, Theme not yet applied");L=e;i=false;return false}else if(y){var m=document.querySelector("LINK[id='"+b+"']");if(m){m.remove();a.debug("ThemeManager: Custom CSS removed")}y=false}}}if(!r&&o&&!C[n]){var f=document.getElementById(u);if(f&&f.getAttribute("data-sap-ui-ready")==="false"&&!(f.sheet&&d.hasSheetCssRules(f.sheet))){s.push(n)}}}n(g,u);if(s.length>0){if(!k){for(var o in g){var c=d.getMetadata(o);if(c&&c.Extends&&c.Extends[0]){k=c.Extends[0];break}}}if(k){s.forEach(function(t){var r="sap-ui-theme-"+t;var i=document.getElementById(r);a.warning("ThemeManager: Custom theme '"+e+"' could not be loaded for library '"+t+"'. "+"Falling back to its base theme '"+k+"'.");I(i,k);C[t]=true});i=false}}if(!i){a.debug("ThemeManager: Theme not yet applied.")}else{L=e}return i}function U(e){var t=window.document.getElementById("sap-ui-theme-"+e);if(!t){return false}var i=window.getComputedStyle(t,":after");var s=i?i.getPropertyValue("content"):null;if(!s&&o.browser.safari){var n=document.documentElement;n.classList.add("sapUiThemeDesignerCustomCss");s=window.getComputedStyle(n,":after").getPropertyValue("content");n.classList.remove("sapUiThemeDesignerCustomCss")}if(s&&s!=="none"){try{if(s[0]==="'"||s[0]==='"'){s=s.substring(1,s.length-1)}return s==="true"}catch(e){r.errorThrows("Custom check: Error parsing JSON string for custom.css indication.",e)}}var u=t.sheet?d.safeAccessSheetCssRules(t.sheet):null;if(!u||u.length===0){a.warning("Custom check: Failed retrieving a CSS rule from stylesheet "+e);return false}for(var c=0;c<2&&c<u.length;c++){if(v.test(u[c].selectorText)){return true}}return false}function A(e){T++;var t=T>p;if(!x()&&!t){var a;if(T<=100){a=2}else if(T<=110){a=500}else{a=1e3}E=setTimeout(A,a)}else if(!e){S.reset();S.themeLoaded=true;S.fireThemeApplied();if(t){r.errorThrows("ThemeManager: max. check cycles reached.")}}else{S.themeLoaded=true}}function R(e){var t=document.getElementById(e);if(t){t.dataset.sapUiFoucmarker=e}}function _(e){var t=document.documentElement;var r=e.new;S._updateThemeUrls(r,true);t.classList.remove("sapUiTheme-"+e.old);t.classList.add("sapUiTheme-"+r);S.checkThemeApplied()}function w(e,t){var r=m.getThemeRoot(t,e);if(r){r=r+(r.slice(-1)=="/"?"":"/")+e.replace(/\./g,"/")+"/themes/"+t+"/";u.registerResourcePath((e+".themes."+t).replace(/\./g,"/"),r)}}function I(e,t,r){var a,i=e.href.search(/[?#]/),n,u,o="library",c=s.getRTL()?"-RTL":"",l,m;var d=/^sap-ui-theme(?:skeleton)?-(.*)$/i.exec(e.id);if(Array.isArray(d)){a=d[1]}else{a=e.id.slice(13)}g[a]=g[a]||{};if(i>-1){n=e.href.substring(0,i);u=e.href.substring(i)}else{n=e.href;u=""}n=n.substring(n.lastIndexOf("/")+1);if((m=a.indexOf("-["))>0){o+=a.slice(m+2,-1);a=a.slice(0,m)}if(n===o+".css"||n===o+"-RTL.css"){n=o+c+".css"}l=new URL(S._getThemePath(a,t)+n+u,document.baseURI).toString();if(l!=e.href){if(r){e.dataset.sapUiFoucmarker=e.id}h(l,e.id)}}function M(e){var t;if(l.getVersionedLibCss()&&e){t="?version="+e.version;if(c._content){t+="&sap-ui-dist-version="+c._content.version}}return t}document.documentElement.classList.add("sapUiTheme-"+m.getTheme());a.info("Declared theme "+m.getTheme(),null);m.attachChange(function(e){var t=e.themeRoots;var r=e.theme;if(t&&t.forceUpdate){S._updateThemeUrls(m.getTheme())}if(r){_(r)}});m.registerThemeManager(S);return S});
//# sourceMappingURL=ThemeManager.js.map